<!DOCTYPE html>
<html>
<head>
	<link rel='stylesheet' href='fullcalendar/fullcalendar.css' />
	<script src='lib/jquery/dist/jquery.min.js'></script>
	<script src='lib/moment/min/moment.min.js'></script>
	

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>   
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
	<script src='fullcalendar/fullcalendar.js'></script>

	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<meta name="google-signin-client_id" content="619527313666-fo2k03rjj7e8te5qd1ktvtkk718pr28h.apps.googleusercontent.com">

	<script>
		var events = [];
		var globalUserId = "test1"; // Replace this with google identity function

		$(document).ready(function() {
			toggleVisibility('addForm');
			toggleVisibility('editForm');
		    $('#calendar').fullCalendar({
		    	dayClick: function(date, jsEvent, view) {
					toggleVisibility('addForm');
					document.getElementById('addEventButton').onclick = function() {
						toggleVisibility('addForm');
						jasonAddEvent(globalUserId, date.format());
					};
		    	},
		    	eventClick: function(calEvent, jsEvent, view) {
		    		var temp = "Title: " + calEvent.title +
		    					"<br>Start Time: " + calEvent.start.format('LLLL') +
		    					"<br>End Time: " + calEvent.end.format('LLLL');
		    		$('#message').html(temp);
		    		$('#myModal').modal().show();
					document.getElementById('editEventButton').onclick = function() {
						toggleVisibility('editForm');
						editEvent(calEvent, globalUserId);
					};
					document.getElementById('delete').onclick = function() {
						// toggleVisibility('editForm');
						deleteEvent(calEvent, globalUserId);
					};
				},
				// eventDrop: function(event, delta, revertFunc, jsView, ui, view ) {
				// 	updateEvent(event,globalUserId,delta);
				// }
		    })

		    getSchedule("1");
		});

		function getSchedule(userId) {
			events = [];
			globalUserId = userId

			$.ajax({
				url: window.location.href + "Tea/" + globalUserId + "/schedule",
				type: "GET",
				data: {},
				dataType: 'json',
				success: function(data) {
					events = data;
					refreshCalendar();
				}
			});
		}

		function addEvent(userId, eventTitle, startTime, endTime) {
			$.ajax({
				url: window.location.href + "tea/" + userId + "/addEvent",
				type: "POST",
				data: JSON.stringify({
					title: eventTitle,
					start: startTime,
					end: endTime
				}),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					events.push(data);
					refreshCalendar();
				}
			});
		}

		function toggleVisibility(form) {
		    var x = document.getElementById(form);
			if (x.style.display === "none") {
       		x.style.display = "block";
    		} else {
        	x.style.display = "none";
   			}		
		} 

		function jasonAddEvent(userId, date) {
			var eventTitle = document.getElementById("addTitle").value;
			var start = convertToMilitary( document.getElementById("addStart").value ); // HH:MM AM/PM format
			var end = convertToMilitary( document.getElementById("addEnd").value );
			var startTime = moment(date+'T'+start+'+00:00');
			var endTime = moment(date+'T'+end+'+00:00');

			$.ajax({
				url: window.location.href + "tea/" + userId + "/jasonAddEvent",
				type: "POST",
				data: JSON.stringify({
					title: eventTitle,
					start: startTime,
					end: endTime,
				}),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					events.push(data);
					refreshCalendar();
				}
			});
		}

		function editEvent(calEvent, userId) {
			var eventTitle = document.getElementById("editTitle").value;
			var start = convertToMilitary( document.getElementById("editStart").value ); // HH:MM AM/PM format
			var end = convertToMilitary( document.getElementById("editEnd").value );
			var date = $.fullCalendar.moment(calEvent.start).format("YYYY-MM-DD")
			var startTime = moment(date+'T'+start+'+00:00');
			var endTime = moment(date+'T'+end+'+00:00');

			$.ajax({
				url: window.location.href + "tea/" + userId + "/editEvent/" + calEvent["id"],
				type: "POST",
				data: JSON.stringify({
					title: eventTitle,
					start: startTime,
					end: endTime,
				}),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					events = data;
					refreshCalendar();
				}
			});
		}

		// function updateEvent(calEvent, userId) {
		// 	var date = $.fullCalendar.moment(calEvent.start).format("YYYY-MM-DD")
		// 	var startTime = moment(date+'T'+start+'+00:00');
		// 	var endTime = moment(date+'T'+end+'+00:00');

		// 	$.ajax({
		// 		url: window.location.href + "tea/" + userId + "/updateEvent/" + calEvent["id"],
		// 		type: "POST",
		// 		data: JSON.stringify({
		// 			start: startTime,
		// 			end: endTime,
		// 		}),
		// 		dataType: 'json',
		// 		contentType: 'application/json',
		// 		success: function(data) {
		// 			alert('success');
		// 			events = data;
		// 			refreshCalendar();
		// 		}
		// 	});
		// }

		function deleteEvent(calEvent, userId) {
			$.ajax({
				url: window.location.href + "tea/" + userId + "/deleteEvent/" + calEvent["id"],
				type: "DELETE",
				data: {},
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					events = data;
					refreshCalendar();
				}
			});
		} 

		function resetServer() {
			$.ajax({
				url: window.location.href + "tea/reset",
				type: "POST",
				data: JSON.stringify({
					userId: globalUserId
				}),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					events = data;
					refreshCalendar();
				}
			});
		}

		function refreshCalendar() {
			$('#calendar').fullCalendar('removeEvents');
			$('#calendar').fullCalendar('renderEvents', events, true);
		}

		function testGetAvailable() {
			var format = 'MMM Do YYYY, h:mm a';

			$.ajax({
				url: window.location.href + "tea/available",
				type: "POST",
				data: JSON.stringify({
					userId: globalUserId,
					start: '2017-10-23T19:00:00+07:00',
					end: '2017-10-23T20:00:00+07:00'
				}),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					var availableString = "";
					data.forEach(function (item) {
						var start = $.fullCalendar.moment(item.availabilityStart).utc().format(format);
						var end = $.fullCalendar.moment(item.availabilityEnd).utc().format(format);
						availableString += "<br>" + item.userId + " is available from " + start + " to " + end;
					});

					$("#availabilityResults").html(availableString);
				}
			});
		}

		function testDatabase() {
			var testObject = {
				field1: "value1",
				field2: "value2",
				object: {
					val1: "is this working",
				}
			}
			var lab = {
				name: "174 Lab",
				ta: "dick",
				questions: [
					{
						title: "How to make design report",
						student: "hasdf",
						likes:7
					},
					{
						title: "How to make database",
						student: "reece",
						likes:1000
					}
				]
			}

			//databaseRef.

			$.ajax({
				url: window.location.href + "tea/testDatabase",
				type: "POST",
				data: JSON.stringify(lab),
				dataType: 'json',
				contentType: 'application/json',
				success: function(data) {
					alert(data);
				}
			})
		}

		function hidedp() {
			$('#datetimepicker3').datetimepicker().hide();
		}

		function convertToMilitary(string) {
			var noSpaces = string.replace(/\s/g,'');
			var size = noSpaces.length;
			var AMPM = noSpaces.substr(size-2,2);
			var hours;
			var minutes;
			var hoursStr;
			if (AMPM == 'PM') {
				if (size == 7 ) {
					hours = Number(noSpaces.substr(0,2));
					minutes = noSpaces.substr(3,2);
					if( hours != 12 )
						hours += 12;
					hoursStr = hours.toString()
				} else {
					hours = Number(noSpaces.charAt(0));
					minutes = noSpaces.substr(2,2);
					hours += 12;
					hoursStr = hours.toString();
				}
			} else {
				if (size == 7 ) {
					hours = Number(noSpaces.substr(0,2));
					minutes = noSpaces.substr(3,2);
					if( hours == 12 ) {
						hoursStr = '00';
					} else {
						hoursStr = hours.toString()
					}
				} else {
					hours = Number(noSpaces.charAt(0));
					minutes = noSpaces.substr(2,2);
					hoursStr = '0' + hours.toString();
				}
			}

			return hoursStr + ':' + minutes;
		}

		function testConvertToMilitary() {
			var test1 = convertToMilitary('3:23 AM');
			var test2 = convertToMilitary('2:43 PM');
			var test3 = convertToMilitary('12:00 AM');
			var test4 = convertToMilitary('12:29 PM');

			$('#test1').html(test1);
			$('#test2').html(test2);
			$('#test3').html(test3);
			$('#test4').html(test4);
		}
	</script>

	<style>
		p {
			font-family: Arial;
		}

		#buttons {
			margin-top: 10px;
			margin-bottom: 10px;	
		}

		.container {
			width: 300px;
			margin: 0;
			padding: 0;
		}
	</style>
</head>
<body>
	<div class="g-signin2" data-onsuccess="onSignIn"></div>

	<script>
		function onSignIn(googleUser) {
		  var profile = googleUser.getBasicProfile();
		  console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
		  console.log('Name: ' + profile.getName());
		  console.log('Image URL: ' + profile.getImageUrl());
		  console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
		}
	</script>

	<br>

	<div id='calendar' style='width:75%; height:75%;'></div>

	<div id='buttons'>
		<button onclick="getSchedule('test1');">test1</button>
		<button onclick="getSchedule('test2');">test2</button>
		<button onclick="getSchedule('test3');">test3</button>
		<button onclick="getSchedule('rjackson@scu.edu');">Reece's Schedule</button>
		<button onclick="addEvent(globalUserId, 'New Event', '2017-10-23T19:00:00', '2017-10-23T23:00:00');">Create Event</button>
		<button onclick="resetServer();">Reset Server</button>
		<button onclick="testGetAvailable();">Check availability on October 23 between 12pm and 1 pm</button>
		<button onclick="testDatabase()";>Test Database</button>
		<button onclick="hidedp();">Hide dp</button>
		<button onclick="testConvertToMilitary()";>Test converToMilitary</button>

	</div>

	<p>Buttons test1, test2, test3, and Reece's Schedule test loading different schedules into the calendar<br>Create event calls the API to create a new event with preloaded values<br>Click on an event to delete/edit it<br>The reset server button resets the original data<br>Click anywhere on the calendar to add an event</p>

	<p id="availabilityResults"></p>
	<p id="test1"></p>
	<p id="test2"></p>
	<p id="test3"></p>
	<p id="test4"></p>
	<p id='test5'></p>

	<!-- https://eonasdan.github.io/bootstrap-datetimepicker/ -->
<div id='addForm'>
	<p>Please enter your event title:<br></p>
	<input type="text" name="addTitle" id="addTitle"><br>

	<p>Please enter a start time:<br></p>
	<div class="container">
    <div class="row">
        <div class='col-sm-6'>
            <div class="form-group">
                <div class='input-group date' id='datetimepicker1'>
                    <input type='text' class="form-control" id='addStart'/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $('#datetimepicker1').datetimepicker({
                    format: 'LT'
                });
            });
        </script>
    </div>
</div>

	<p>Please enter an end time:<br></p>

	<div class="container">
    <div class="row">
        <div class='col-sm-6'>
            <div class="form-group">
                <div class='input-group date' id='datetimepicker2'>
                    <input type='text' class="form-control" id='addEnd'/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $('#datetimepicker2').datetimepicker({
                    format: 'LT'
                });
            });
        </script>
    </div>
</div>

	<div>
	<button id='cancel' onclick="toggleVisibility('addForm')">Cancel</button>
	<button id='addEventButton'>Submit</button>
	</div>

</div>

<div id='editForm'>
	<p>Please enter your new event title:<br></p>
	<input type="text" name="editTitle" id="editTitle"><br>

	<p>Please enter a new start time:<br></p>
	<div class="container">
    <div class="row">
        <div class='col-sm-6'>
            <div class="form-group">
                <div class='input-group date' id='datetimepicker3'>
                    <input type='text' class="form-control" id='editStart'/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $('#datetimepicker3').datetimepicker({
                    format: 'LT'
                });
            });
        </script>
    </div>
</div>

	<p>Please enter a new end time:<br></p>

	<div class="container">
    <div class="row">
        <div class='col-sm-6'>
            <div class="form-group">
                <div class='input-group date' id='datetimepicker4'>
                    <input type='text' class="form-control" id='editEnd'/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $('#datetimepicker4').datetimepicker({
                    format: 'LT'
                });
            });
        </script>
    </div>
</div>

	<div>
	<button id='cancel' onclick="toggleVisibility('editForm')">Cancel</button>
	<!-- <button id='delete'>Delete Event</button> -->
	<button id='editEventButton'">Submit</button>
	</div>

</div>

<!-- https://www.w3schools.com/bootstrap/bootstrap_modal.asp -->
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Event Information</h4>
      </div>
      <div class="modal-body">
      	<p id='message'></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" id='delete'>Delete Event</button>
		<button type="button" class="btn btn-default" data-dismiss="modal" id='edit' onclick="toggleVisibility('editForm')">Edit Event</button>
      </div>
    </div>

  </div>
</div>

</bodY>
</html>